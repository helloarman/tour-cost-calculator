<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tour Contribution Calculator</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#FFD633"/>
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiB2aWV3Qm94PSIwIDAgMTkyIDE5MiI+PHJlY3Qgd2lkdGg9IjE5MiIgaGVpZ2h0PSIxOTIiIGZpbGw9IiNGRkQ2MzMiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9IlBvcHBpbnMsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iODAiIGZvbnQtd2VpZ2h0PSJib2xkIiBmaWxsPSIjMTExMTExIj5UQ0M8L3RleHQ+PC9zdmc+">
    <script>
        // Create manifest file dynamically and link it
        const manifest = {
          "name": "Tour Contribution Calculator",
          "short_name": "TourCalc",
          "description": "A cost management system for shared trips.",
          "start_url": ".",
          "display": "standalone",
          "background_color": "#F5F6FA",
          "theme_color": "#FFD633",
          "icons": [
            {
              "src": "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiB2aWV3Qm94PSIwIDAgMTkyIDE5MiI+PHJlY3Qgd2lkdGg9IjE5MiIgaGVpZ2h0PSIxOTIiIGZpbGw9IiNGRkQ2MzMiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9IlBvcHBpbnMsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iODAiIGZvbnQtd2VpZ2h0PSJib2xkIiBmaWxsPSIjMTExMTExIj5UQ0M8L3RleHQ+PC9zdmc+",
              "sizes": "192x192",
              "type": "image/svg+xml",
              "purpose": "any maskable"
            },
            {
              "src": "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MTIiIGhlaWdodD0iNTEyIiB2aWV3Qm94PSIwIDAgNTEyIDUxMiI+PHJlY3Qgd2lkdGg9IjUxMiIgaGVpZ2h0PSI1MTIiIGZpbGw9IiNGRkQ2MzMiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9IlBvcHBpbnMsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMjAwIiBmb250LXdlaWdodD0iYm9sZCIgZmlsbD0iIzExMTExMSI+VENDPC90ZXh0Pjwvc3ZnPg==",
              "sizes": "512x512",
              "type": "image/svg+xml",
              "purpose": "any maskable"
            }
          ]
        };
        const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
        const manifestUrl = URL.createObjectURL(manifestBlob);
        const link = document.createElement('link');
        link.rel = 'manifest';
        link.href = manifestUrl;
        document.head.appendChild(link);
    </script>
    
    <!-- Google Fonts: Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <style>
        /* --- Design System Variables --- */
        :root {
            /* Theme */
            --primary-color: #FFD633;
            --secondary-color: #111111;
            --background-color: #F5F6FA;
            --card-background: #FFFFFF;
            --accent-color: #FFB400;
            --text-color-primary: #111111;
            --text-color-secondary: #555555;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --border-color: #E5E5E5;
            --error-color: #e74c3c;
            --success-color: #2e7d32;

            /* Typography */
            --font-family: 'Poppins', sans-serif;
            --headline-size: 22px;
            --subheadline-size: 18px;
            --body-size: 14px;
            --caption-size: 12px;
            --font-weight-light: 300;
            --font-weight-regular: 400;
            --font-weight-medium: 500;
            --font-weight-bold: 600;
            --line-height: 1.5;

            /* Layout */
            --border-radius-card: 24px;
            --border-radius-button: 18px;
            --border-radius-input: 14px;
            --spacing-small: 8px;
            --spacing-medium: 16px;
            --spacing-large: 24px;
            --max-card-width: 360px;
            --shadow-small: 0px 4px 10px var(--shadow-color);
            --shadow-medium: 0px 8px 20px rgba(0,0,0,0.15);

            /* Animation */
            --transition-speed: 0.3s;
        }

        /* --- Global Styles & Resets --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--background-color);
            color: var(--text-color-primary);
            font-size: var(--body-size);
            padding: var(--spacing-large);
            padding-bottom: 120px; /* Space for fixed navbar */
        }

        /* --- Main Layout --- */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            gap: var(--spacing-large);
        }

        .main-header {
            text-align: center;
            margin-bottom: var(--spacing-medium);
        }

        .main-header h1 {
            font-size: var(--headline-size);
            font-weight: var(--font-weight-bold);
            color: var(--secondary-color);
        }
         .main-header p {
            color: var(--text-color-secondary);
            font-size: var(--body-size);
        }
        
        .actions-toolbar {
            display: flex;
            justify-content: center;
            gap: var(--spacing-small);
            margin: 0 auto var(--spacing-large) auto;
        }


        /* --- Component: Input & Forms --- */
        .add-member-form {
            display: flex;
            gap: var(--spacing-small);
            flex-grow: 1;
            max-width: var(--max-card-width);
        }

        .input-field, .select-field {
            flex-grow: 1;
            background: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-input);
            padding: 12px 16px;
            font-family: var(--font-family);
            font-size: var(--body-size);
            font-weight: var(--font-weight-medium);
            transition: border-color var(--transition-speed), box-shadow var(--transition-speed);
        }
        .input-field::placeholder {
            color: #AAAAAA;
            font-weight: var(--font-weight-regular);
        }
        .input-field:focus, .select-field:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(255, 214, 51, 0.3);
        }
        
        /* --- Component: Buttons --- */
        .cta-button {
            background: var(--primary-color);
            color: var(--text-color-primary);
            border-radius: var(--border-radius-button);
            font-weight: var(--font-weight-bold);
            padding: 12px 24px;
            border: none;
            cursor: pointer;
            font-family: var(--font-family);
            font-size: var(--body-size);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-small);
            transition: transform var(--transition-speed), opacity var(--transition-speed);
        }
        .cta-button:hover {
            transform: scale(1.03);
        }
        .cta-button:active {
            opacity: 0.85;
            transform: scale(0.98);
        }
        .button-sm {
            padding: 8px 16px;
            border-radius: 12px;
            font-size: var(--caption-size);
        }
        .icon-button {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 4px;
            line-height: 0;
            color: var(--text-color-secondary);
            transition: color var(--transition-speed), transform var(--transition-speed);
        }
        .icon-button:hover {
            color: var(--secondary-color);
            transform: scale(1.1);
        }
        .icon-button.remove-member-btn:hover {
            color: var(--error-color);
        }
        .icon-button svg {
            width: 16px;
            height: 16px;
        }
        
        /* --- Component: Summary Cards --- */
        .summary-section {
            display: flex;
            justify-content: center;
            gap: var(--spacing-medium);
            flex-wrap: wrap;
        }
        .summary-card {
            background: var(--card-background);
            border-radius: var(--border-radius-card);
            padding: var(--spacing-medium) var(--spacing-large);
            box-shadow: var(--shadow-small);
            text-align: center;
            flex-grow: 1;
            max-width: var(--max-card-width);
        }
        .summary-card-title {
            font-size: var(--body-size);
            color: var(--text-color-secondary);
            margin-bottom: var(--spacing-small);
        }
        .summary-card-value {
            font-size: var(--subheadline-size);
            font-weight: var(--font-weight-bold);
            color: var(--secondary-color);
        }
        .summary-card-value span {
            font-weight: var(--font-weight-regular);
            font-size: var(--body-size);
        }

        /* --- Component: Member Cards --- */
        .members-section {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: var(--spacing-large);
            justify-content: center;
        }
        .member-card {
            background: var(--card-background);
            border-radius: var(--border-radius-card);
            padding: var(--spacing-medium);
            box-shadow: var(--shadow-small);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-medium);
            max-width: var(--max-card-width);
            margin: 0 auto;
            width: 100%;
        }
        .member-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: var(--spacing-medium);
        }
        .member-card-title {
            font-size: 16px;
            font-weight: var(--font-weight-bold);
            display: flex;
            align-items: center;
            gap: var(--spacing-small);
        }
        .contributions-list {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-small);
            min-height: 50px;
        }
        .contribution-item, .transfer-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: var(--body-size);
            background: #fafafa;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color var(--transition-speed);
        }
        .contribution-item:hover {
            background-color: #f0f0f0;
        }
        .transfer-item {
            cursor: default;
        }
        .transfer-item .contribution-title {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .transfer-item.transfer-in .contribution-amount { color: var(--success-color); }
        .transfer-item.transfer-out .contribution-amount { color: var(--error-color); }
        .contribution-title {
            color: var(--text-color-secondary);
        }
        .contribution-amount {
            font-weight: var(--font-weight-medium);
            color: var(--text-color-primary);
        }
        .empty-contributions {
            text-align: center;
            color: var(--text-color-secondary);
            font-size: var(--caption-size);
            padding: var(--spacing-medium);
        }

        /* --- Component: Navbar (Bottom) --- */
        .bottom-nav {
            position: fixed;
            bottom: var(--spacing-large);
            left: 50%;
            transform: translateX(-50%);
            background: var(--card-background);
            border-radius: 30px;
            padding: var(--spacing-small);
            box-shadow: var(--shadow-medium);
            z-index: 100;
            display: flex;
            gap: var(--spacing-medium);
        }
        .nav-button-group {
            display: flex;
            gap: var(--spacing-small);
        }
        
        /* --- Component: Modal --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--transition-speed), visibility var(--transition-speed);
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background: var(--card-background);
            border-radius: var(--border-radius-card);
            padding: var(--spacing-large);
            box-shadow: var(--shadow-medium);
            width: 90%;
            max-width: 400px;
            transform: scale(0.9);
            transition: transform var(--transition-speed);
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-overlay.active .modal-content {
            transform: scale(1);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-medium);
        }
        .modal-title {
            font-size: var(--subheadline-size);
            font-weight: var(--font-weight-bold);
        }
        #contribution-form, #transfer-form, #edit-member-form, #contribution-details-form {
            display: grid;
            gap: var(--spacing-medium);
        }
        #settings-modal .modal-content {
             display: grid;
            gap: var(--spacing-large);
        }
        .settings-section {
            border-top: 1px solid var(--border-color);
            padding-top: var(--spacing-large);
        }
        .settings-section h3 {
             font-size: var(--body-size);
             font-weight: var(--font-weight-bold);
             margin-bottom: var(--spacing-medium);
        }
        .settings-actions {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-medium);
        }

        .form-group {
            display: grid;
            gap: var(--spacing-small);
        }
        .form-group label {
            font-weight: var(--font-weight-medium);
        }
        .modal-actions {
            display: flex;
            gap: var(--spacing-small);
            justify-content: flex-end;
            margin-top: var(--spacing-medium);
        }
        .button-secondary {
            background-color: #eee;
            color: var(--secondary-color);
        }
        .button-danger {
            background-color: var(--error-color);
            color: white;
        }
        .member-card-summary {
            border-top: 1px solid var(--border-color);
            padding-top: var(--spacing-medium);
            margin-top: var(--spacing-small);
            display: grid;
            gap: var(--spacing-small);
        }
        .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .member-total-label {
            font-size: var(--caption-size);
            color: var(--text-color-secondary);
        }
        .member-total-amount {
            font-size: var(--body-size);
            font-weight: var(--font-weight-bold);
        }
        .balance-info {
            font-weight: var(--font-weight-bold);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: var(--caption-size);
            text-align: right;
        }
        .positive-balance {
            background-color: #e8f5e9; /* Light Green */
            color: #2e7d32; /* Dark Green */
        }
        .negative-balance {
            background-color: #ffebee; /* Light Red */
            color: var(--error-color);
        }
        .settled-balance {
            background-color: #f5f5f5; /* Light Grey */
            color: var(--text-color-secondary);
        }
        
        /* Member Select List (Chips) */
        .member-select-list {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-small);
        }
        .member-select-item {
            background-color: #f0f0f0;
            border: 1px solid transparent;
            border-radius: 20px;
            padding: 6px 12px;
            font-size: var(--caption-size);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
            user-select: none;
        }
        .member-select-item.selected {
            background-color: #fff9db; /* Light Yellow */
            border-color: var(--primary-color);
            color: var(--secondary-color);
            font-weight: var(--font-weight-medium);
        }
        .member-select-item:not(.selected) {
            opacity: 0.6;
            text-decoration: line-through;
        }

        /* --- History Styles --- */
        .history-list {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-medium);
        }
        .history-item {
            display: flex;
            gap: var(--spacing-medium);
            padding-bottom: var(--spacing-medium);
            border-bottom: 1px solid var(--border-color);
        }
        .history-item:last-child {
            border-bottom: none;
        }
        .history-icon {
            background: #f0f0f0;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            color: var(--text-color-secondary);
        }
        .history-icon.contribution {
            background-color: #fff9db; /* Light Primary */
            color: var(--accent-color);
        }
        .history-icon.transfer {
            background-color: #e3f2fd; /* Light Blue */
            color: #2196f3;
        }
        .history-icon.waiver {
            background-color: #f3e5f5; /* Light Purple */
            color: #9c27b0;
        }
        .history-content {
            flex-grow: 1;
        }
        .history-title {
            font-weight: var(--font-weight-bold);
            font-size: var(--body-size);
            color: var(--secondary-color);
            margin-bottom: 2px;
        }
        .history-meta {
            font-size: var(--caption-size);
            color: var(--text-color-secondary);
            margin-bottom: 4px;
        }
        .history-amount {
            font-weight: var(--font-weight-bold);
            color: var(--text-color-primary);
        }
        .history-details {
            font-size: var(--caption-size);
            color: var(--text-color-secondary);
            font-style: italic;
        }

        /* --- Modal Tabs --- */
        .modal-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: var(--spacing-medium);
            position: sticky;
            top: 0;
            background: var(--card-background);
            z-index: 10;
        }
        .modal-tab {
            flex: 1;
            text-align: center;
            padding: 12px 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: var(--font-weight-medium);
            color: var(--text-color-secondary);
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .modal-tab:hover {
            background-color: #fafafa;
        }
        .modal-tab.active {
            color: var(--secondary-color);
            border-bottom-color: var(--primary-color);
            font-weight: var(--font-weight-bold);
        }

        /* --- Mobile Responsiveness --- */
        @media (max-width: 768px) {
            body {
                padding: var(--spacing-medium);
                padding-bottom: 120px; /* Keep space for nav */
            }

            .main-header h1 {
                font-size: 20px; /* Slightly smaller headline */
            }

            .actions-toolbar {
                flex-direction: column;
                align-items: stretch; /* Make children full-width */
                max-width: 100%;
                padding: 0 var(--spacing-medium);
            }
            
            .add-member-form {
                width: 100%;
            }

            .summary-section {
                flex-direction: column;
                padding: 0 var(--spacing-medium);
            }
            .summary-card {
                max-width: 100%;
            }
        }
        @media (max-width: 540px) {
            .bottom-nav {
                flex-direction: column;
                gap: var(--spacing-small);
            }
        }

        @media (max-width: 480px) {
            :root {
                /* Slightly smaller fonts for very small screens */
                --headline-size: 20px;
                --subheadline-size: 16px;
                --body-size: 13px;
                --caption-size: 11px;
            }
            
            .add-member-form {
                flex-direction: column;
            }

            .cta-button {
                padding: 12px 20px;
                font-size: var(--body-size);
            }

            .modal-content {
                padding: var(--spacing-medium);
            }

        }
    </style>
</head>
<body>

    <div class="container">
        <header class="main-header">
            <h1 id="tour-title-header">Tour Contribution Calculator</h1>
            <p>Manage shared trip costs with ease.</p>
        </header>

        <div class="actions-toolbar">
            <!-- Add New Member Form -->
            <form id="add-member-form" class="add-member-form">
                <input type="text" id="member-name-input" class="input-field" placeholder="Enter member's name" required>
                <button type="submit" class="cta-button">Add</button>
            </form>
            <button id="transfer-button" class="cta-button button-secondary">Transfer</button>
        </div>


        <!-- Summary Section -->
        <section id="summary-section" class="summary-section">
            <div class="summary-card">
                <div class="summary-card-title">Total Contribution</div>
                <div class="summary-card-value" id="total-contribution">৳0.00</div>
            </div>
            <div class="summary-card">
                <div class="summary-card-title">Equal Share (Avg)</div>
                <div class="summary-card-value" id="equal-share">৳0.00 <span>per person</span></div>
            </div>
            <div class="summary-card">
                <div class="summary-card-title">Total Waivers</div>
                <div class="summary-card-value" id="total-waivers">৳0.00</div>
            </div>
        </section>
        
        <!-- Members Section -->
        <main id="members-section" class="members-section"></main>

    </div>

    <!-- Bottom Navbar -->
    <nav class="bottom-nav">
        <div class="nav-button-group">
            <button id="history-button" class="cta-button button-secondary">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8v4l3 3"></path><circle cx="12" cy="12" r="10"></circle></svg>
                <span>History</span>
            </button>
            <button id="download-report-button" class="cta-button button-secondary">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                <span>Report</span>
            </button>
             <button id="copy-report-button" class="cta-button button-secondary">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                <span>Copy</span>
            </button>
            <button id="settings-button" class="cta-button">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                <span>Settings</span>
            </button>
        </div>
    </nav>
    
    <!-- Settings Modal -->
    <div id="settings-modal" class="modal-overlay">
        <div class="modal-content">
            <header class="modal-header">
                <h2 class="modal-title">Settings & Data</h2>
                <button class="icon-button close-modal-btn">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </header>
            
            <div class="form-group">
                <label for="tour-name-input">Tour Name</label>
                <input type="text" id="tour-name-input" class="input-field" placeholder="e.g., Summer Road Trip">
            </div>

            <div class="settings-section">
                <h3>Data Management</h3>
                <div class="settings-actions">
                    <button id="backup-button" class="cta-button button-secondary">Backup Data</button>
                    <label for="upload-input" class="cta-button button-secondary">Restore Data</label>
                    <input type="file" id="upload-input" accept=".json" style="display: none;">
                </div>
            </div>

            <div class="settings-section">
                <h3>All of your adjustments adjusted?</h3>
                 <button id="reset-button" class="cta-button button-danger" style="width: 100%;">Reset Journey</button>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div id="history-modal" class="modal-overlay">
        <div class="modal-content">
            <header class="modal-header" style="margin-bottom: 0; padding-bottom: var(--spacing-small);">
                <h2 class="modal-title">Activity History</h2>
                <button class="icon-button close-modal-btn">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </header>
            
            <div class="modal-tabs">
                <div class="modal-tab active" data-tab="all">All</div>
                <div class="modal-tab" data-tab="contribution">Contributions</div>
                <div class="modal-tab" data-tab="transfer">Transfers</div>
                <div class="modal-tab" data-tab="waiver">Waivers</div>
            </div>

            <div id="history-container">
                <ul id="history-list" class="history-list">
                    <!-- History items injected here -->
                </ul>
                <p id="no-history-msg" class="empty-contributions" style="display:none;">No activity recorded yet.</p>
            </div>
        </div>
    </div>


    <!-- Contribution Modal (Add) -->
    <div id="contribution-modal" class="modal-overlay">
        <div class="modal-content">
            <header class="modal-header">
                <h2 class="modal-title" id="contribution-modal-title">Add Contribution</h2>
                <button class="icon-button close-modal-btn">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </header>
            <form id="contribution-form">
                <input type="hidden" id="contribution-member-id">
                <div class="form-group">
                    <label for="contribution-title">Title</label>
                    <input type="text" id="contribution-title" class="input-field" placeholder="e.g., Fuel, Groceries" required>
                </div>
                <div class="form-group">
                    <label for="contribution-amount">Amount (৳)</label>
                    <input type="number" id="contribution-amount" class="input-field" placeholder="0.00" step="0.01" min="0" required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="cta-button button-secondary cancel-modal-btn">Cancel</button>
                    <button type="submit" class="cta-button">Add</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Contribution & Exceptions Modal -->
    <div id="contribution-details-modal" class="modal-overlay">
        <div class="modal-content">
            <header class="modal-header">
                <h2 class="modal-title">Contribution Details</h2>
                <button class="icon-button close-modal-btn">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </header>
            <form id="contribution-details-form">
                <input type="hidden" id="detail-contribution-id">
                <div class="form-group">
                    <label for="detail-title">Title</label>
                    <input type="text" id="detail-title" class="input-field" required>
                </div>
                <div class="form-group">
                    <label for="detail-amount">Amount (৳)</label>
                    <input type="number" id="detail-amount" class="input-field" step="0.01" min="0" required>
                </div>
                
                <div class="form-group">
                    <label>Split among (Uncheck to except):</label>
                    <div id="exception-members-list" class="member-select-list">
                        <!-- Chips will be injected here -->
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="cta-button button-secondary cancel-modal-btn">Cancel</button>
                    <button type="submit" class="cta-button">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Member Modal -->
    <div id="edit-member-modal" class="modal-overlay">
        <div class="modal-content">
            <header class="modal-header">
                <h2 class="modal-title" id="edit-member-modal-title">Edit Member</h2>
                <button class="icon-button close-modal-btn">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </header>
            <form id="edit-member-form">
                <input type="hidden" id="edit-member-id">
                <div class="form-group">
                    <label for="edit-member-name">Member Name</label>
                    <input type="text" id="edit-member-name" class="input-field" required>
                </div>
                <div class="form-group">
                    <label for="edit-member-waiver">Personal Waiver (৳)</label>
                    <input type="number" id="edit-member-waiver" class="input-field" placeholder="0.00" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label>Distribute Waiver Among:</label>
                    <div style="font-size: 11px; color: var(--text-color-secondary); margin-bottom: 4px;">If none selected, splits among all others.</div>
                    <div id="waiver-distribute-list" class="member-select-list">
                        <!-- Chips will be injected here -->
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="cta-button button-secondary cancel-modal-btn">Cancel</button>
                    <button type="submit" class="cta-button">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Transfer Modal -->
    <div id="transfer-modal" class="modal-overlay">
        <div class="modal-content">
            <header class="modal-header">
                <h2 class="modal-title">Transfer Money</h2>
                <button class="icon-button close-modal-btn">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </header>
            <form id="transfer-form">
                <div class="form-group">
                    <label for="transfer-from">From</label>
                    <select id="transfer-from" class="select-field" required></select>
                </div>
                <div class="form-group">
                    <label for="transfer-to">To</label>
                    <select id="transfer-to" class="select-field" required></select>
                </div>
                <div class="form-group">
                    <label for="transfer-amount">Amount (৳)</label>
                    <input type="number" id="transfer-amount" class="input-field" placeholder="0.00" step="0.01" min="0" required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="cta-button button-secondary cancel-modal-btn">Cancel</button>
                    <button type="submit" class="cta-button">Confirm Transfer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-content">
            <header class="modal-header">
                <h2 class="modal-title" id="confirm-modal-title">Are you sure?</h2>
            </header>
            <p id="confirm-modal-text" style="margin: var(--spacing-medium) 0; color: var(--text-color-secondary);"></p>
            <div class="modal-actions">
                <button type="button" id="confirm-cancel-btn" class="cta-button button-secondary">Cancel</button>
                <button type="button" id="confirm-ok-btn" class="cta-button button-danger">Confirm</button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const tourTitleHeader = document.getElementById('tour-title-header');
            const addMemberForm = document.getElementById('add-member-form');
            const memberNameInput = document.getElementById('member-name-input');
            const membersSection = document.getElementById('members-section');
            const totalContributionEl = document.getElementById('total-contribution');
            const equalShareEl = document.getElementById('equal-share');
            const totalWaiversEl = document.getElementById('total-waivers');
            const transferButton = document.getElementById('transfer-button');
            const historyButton = document.getElementById('history-button');
            const downloadReportButton = document.getElementById('download-report-button');
            const copyReportButton = document.getElementById('copy-report-button');
            const settingsButton = document.getElementById('settings-button');
            
            // Settings Modal Elements
            const settingsModal = document.getElementById('settings-modal');
            const tourNameInput = document.getElementById('tour-name-input');
            const backupButton = document.getElementById('backup-button');
            const uploadInput = document.getElementById('upload-input');
            const resetButton = document.getElementById('reset-button');

            // History Modal Elements
            const historyModal = document.getElementById('history-modal');
            const historyList = document.getElementById('history-list');
            const noHistoryMsg = document.getElementById('no-history-msg');
            const historyTabs = document.querySelectorAll('.modal-tab');

            // Contribution Modal Elements (Add)
            const contributionModal = document.getElementById('contribution-modal');
            const contributionModalTitle = document.getElementById('contribution-modal-title');
            const contributionForm = document.getElementById('contribution-form');
            const contributionMemberIdInput = document.getElementById('contribution-member-id');
            const contributionTitleInput = document.getElementById('contribution-title');
            const contributionAmountInput = document.getElementById('contribution-amount');
            
            // Contribution Details Modal Elements (Edit/Exceptions)
            const contributionDetailsModal = document.getElementById('contribution-details-modal');
            const contributionDetailsForm = document.getElementById('contribution-details-form');
            const detailContributionIdInput = document.getElementById('detail-contribution-id');
            const detailTitleInput = document.getElementById('detail-title');
            const detailAmountInput = document.getElementById('detail-amount');
            const exceptionMembersList = document.getElementById('exception-members-list');

            // Edit Member Modal Elements
            const editMemberModal = document.getElementById('edit-member-modal');
            const editMemberModalTitle = document.getElementById('edit-member-modal-title');
            const editMemberForm = document.getElementById('edit-member-form');
            const editMemberIdInput = document.getElementById('edit-member-id');
            const editMemberNameInput = document.getElementById('edit-member-name');
            const editMemberWaiverInput = document.getElementById('edit-member-waiver');
            const waiverDistributeList = document.getElementById('waiver-distribute-list');

            // Transfer Modal Elements
            const transferModal = document.getElementById('transfer-modal');
            const transferForm = document.getElementById('transfer-form');
            const transferFromSelect = document.getElementById('transfer-from');
            const transferToSelect = document.getElementById('transfer-to');
            const transferAmountInput = document.getElementById('transfer-amount');

            // Generic Modal Elements
            const allModals = document.querySelectorAll('.modal-overlay');
            const closeButtons = document.querySelectorAll('.close-modal-btn');
            const cancelButtons = document.querySelectorAll('.cancel-modal-btn');

            // Confirm Modal Elements
            const confirmModal = document.getElementById('confirm-modal');
            const confirmModalText = document.getElementById('confirm-modal-text');
            const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
            const confirmOkBtn = document.getElementById('confirm-ok-btn');

            // --- State Management ---
            let members = [];
            let contributions = [];
            let transfers = [];
            let tourName = 'Tour Contribution Calculator';
            let confirmCallback = null;

            const storageKeys = {
                members: 'tour_members',
                contributions: 'tour_contributions',
                transfers: 'tour_transfers',
                tourName: 'tour_name'
            };

            // --- Functions ---
            const setCookie = (name, value, days) => {
                let expires = "";
                if (days) {
                    const date = new Date();
                    date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                    expires = "; expires=" + date.toUTCString();
                }
                document.cookie = name + "=" + (encodeURIComponent(value) || "")  + expires + "; path=/; SameSite=Lax";
            };

            const getCookie = (name) => {
                const nameEQ = name + "=";
                const ca = document.cookie.split(';');
                for(let i=0; i < ca.length; i++) {
                    let c = ca[i];
                    while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                    if (c.indexOf(nameEQ) === 0) {
                        return decodeURIComponent(c.substring(nameEQ.length, c.length));
                    }
                }
                return null;
            };

            const saveState = () => {
                setCookie(storageKeys.members, JSON.stringify(members), 365);
                setCookie(storageKeys.contributions, JSON.stringify(contributions), 365);
                setCookie(storageKeys.transfers, JSON.stringify(transfers), 365);
                setCookie(storageKeys.tourName, tourName, 365);
            };

            const loadState = () => {
                const membersCookie = getCookie(storageKeys.members);
                const contributionsCookie = getCookie(storageKeys.contributions);
                const transfersCookie = getCookie(storageKeys.transfers);
                const tourNameCookie = getCookie(storageKeys.tourName);

                try {
                    members = membersCookie ? JSON.parse(membersCookie) : [];
                    members.forEach(m => {
                        if (m.waiver === undefined) m.waiver = 0;
                        if (!m.waiverDistributeIds) m.waiverDistributeIds = [];
                    });

                    contributions = contributionsCookie ? JSON.parse(contributionsCookie) : [];
                    // Ensure excludedMembers array exists
                    contributions.forEach(c => {
                        if (!c.excludedMembers) c.excludedMembers = [];
                    });

                    transfers = transfersCookie ? JSON.parse(transfersCookie) : [];
                    tourName = tourNameCookie || 'Tour Contribution Calculator';
                } catch (e) {
                    console.error("Error parsing cookies, resetting state.", e);
                    members = [];
                    contributions = [];
                    transfers = [];
                    tourName = 'Tour Contribution Calculator';
                }
            };
            
            const formatCurrency = (amount, addSign = false) => {
                const formatted = `৳${Math.abs(amount).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                if (addSign) {
                    return (amount >= 0 ? '+' : '-') + formatted;
                }
                return formatted;
            };

            const render = () => {
                tourTitleHeader.textContent = tourName || 'Tour Contribution Calculator';
                tourNameInput.value = tourName;

                // --- Core Calculation Logic ---
                // 1. Base Shares from Contributions
                const finalMemberCosts = {};
                members.forEach(m => finalMemberCosts[m.id] = 0);

                contributions.forEach(c => {
                    const excluded = c.excludedMembers || [];
                    const includedCount = members.length - excluded.length;
                    
                    if (includedCount > 0) {
                        const sharePerPerson = c.amount / includedCount;
                        members.forEach(m => {
                            if (!excluded.includes(m.id)) {
                                finalMemberCosts[m.id] += sharePerPerson;
                            }
                        });
                    }
                });

                // 2. Apply Waivers (Shift costs)
                members.forEach(m => {
                    const waiver = m.waiver || 0;
                    if (waiver > 0) {
                        // Subtract waiver from the beneficiary
                        finalMemberCosts[m.id] -= waiver;

                        // Distribute cost to others
                        const distributeIds = m.waiverDistributeIds || [];
                        // Filter targets: must exist and not be self
                        let targets = members.filter(mem => mem.id !== m.id && distributeIds.includes(mem.id));
                        
                        // Default to "All Others" if no specific targets selected
                        if (targets.length === 0) {
                            targets = members.filter(mem => mem.id !== m.id);
                        }

                        if (targets.length > 0) {
                            const share = waiver / targets.length;
                            targets.forEach(target => {
                                finalMemberCosts[target.id] += share;
                            });
                        }
                    }
                });

                const totalContribution = contributions.reduce((sum, c) => sum + c.amount, 0);
                const totalWaivers = members.reduce((sum, m) => sum + (m.waiver || 0), 0);
                const averageShare = members.length > 0 ? totalContribution / members.length : 0;
                
                // Render Members
                membersSection.innerHTML = '';
                if (members.length === 0) {
                     membersSection.innerHTML = '<p style="text-align: center; color: var(--text-color-secondary); grid-column: 1 / -1;">No members yet. Add one to get started!</p>';
                } else {
                    members.forEach(member => {
                        const memberContributions = contributions.filter(c => c.memberId === member.id);
                        const memberTotalContributions = memberContributions.reduce((sum, c) => sum + c.amount, 0);
                        
                        const transfersSent = transfers.filter(t => t.fromId === member.id);
                        const totalSent = transfersSent.reduce((sum, t) => sum + t.amount, 0);

                        const transfersReceived = transfers.filter(t => t.toId === member.id);
                        const totalReceived = transfersReceived.reduce((sum, t) => sum + t.amount, 0);

                        const effectiveTotalPaid = memberTotalContributions + totalSent - totalReceived;
                        
                        // Final Share is now fully calculated in finalMemberCosts
                        const finalPersonalShare = finalMemberCosts[member.id];
                        
                        // Balance
                        const balance = effectiveTotalPaid - finalPersonalShare;

                        const memberCard = document.createElement('div');
                        memberCard.className = 'member-card';
                        memberCard.dataset.memberId = member.id;
                        
                        const activityLog = [
                            ...memberContributions.map(c => ({ ...c, type: 'contribution', date: c.id })),
                            ...transfersSent.map(t => ({ ...t, type: 'transfer-out', date: t.id })),
                            ...transfersReceived.map(t => ({ ...t, type: 'transfer-in', date: t.id }))
                        ].sort((a, b) => a.date - b.date);

                        let activityHtml = activityLog.length > 0
                            ? activityLog.map(item => {
                                if (item.type === 'contribution') {
                                    const excluded = item.excludedMembers || [];
                                    const isEveryone = excluded.length === 0;
                                    const splitText = isEveryone ? '' : ` <span style="font-size:10px; color:var(--error-color);">(${members.length - excluded.length} ppl)</span>`;
                                    
                                    return `
                                    <li class="contribution-item" data-contribution-id="${item.id}">
                                        <span class="contribution-title">${item.title}${splitText}</span>
                                        <div>
                                            <span class="contribution-amount">${formatCurrency(item.amount)}</span>
                                            <button class="icon-button remove-contribution-btn">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                            </button>
                                        </div>
                                    </li>`;
                                } else if (item.type === 'transfer-out') {
                                    const toMember = members.find(m => m.id === item.toId);
                                    return `
                                    <li class="transfer-item transfer-out">
                                        <span class="contribution-title">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>
                                            To ${toMember ? toMember.name : 'Unknown'}
                                        </span>
                                        <span class="contribution-amount">${formatCurrency(item.amount, true)}</span>
                                    </li>`;
                                } else { // transfer-in
                                    const fromMember = members.find(m => m.id === item.fromId);
                                    return `
                                    <li class="transfer-item transfer-in">
                                        <span class="contribution-title">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
                                            From ${fromMember ? fromMember.name : 'Unknown'}
                                        </span>
                                        <span class="contribution-amount">${formatCurrency(item.amount, true)}</span>
                                    </li>`;
                                }
                            }).join('')
                            : '<li class="empty-contributions">No activity yet.</li>';
                        
                        let balanceHtml = '';
                        if (members.length > 0 && totalContribution > 0) {
                            if (Math.abs(balance) < 0.01) {
                                balanceHtml = `<div class="balance-info settled-balance">Settled Up</div>`;
                            } else if (balance > 0) {
                                balanceHtml = `<div class="balance-info positive-balance">Gets back ${formatCurrency(balance)}</div>`;
                            } else {
                                balanceHtml = `<div class="balance-info negative-balance">Owes ${formatCurrency(Math.abs(balance))}</div>`;
                            }
                        }
                        
                        const waiverHtml = (member.waiver || 0) > 0 ? `
                            <div class="summary-row">
                                <div class="member-total-label">Waiver</div>
                                <div class="member-total-amount">${formatCurrency(member.waiver)}</div>
                            </div>
                        ` : '';

                        memberCard.innerHTML = `
                            <div class="member-card-header">
                                <h2 class="member-card-title">
                                    <span>${member.name}</span>
                                    <button class="icon-button edit-member-btn">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                                    </button>
                                </h2>
                                <button class="icon-button remove-member-btn">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                                </button>
                            </div>
                            <ul class="contributions-list">
                                ${activityHtml}
                            </ul>
                            <div class="member-card-summary">
                                <div class="summary-row">
                                    <div class="member-total-label">Effective Paid</div>
                                    <div class="member-total-amount">${formatCurrency(effectiveTotalPaid)}</div>
                                </div>
                                ${waiverHtml}
                                <div class="summary-row">
                                     <div class="member-total-label">Final Share</div>
                                     <div class="member-total-amount">${formatCurrency(finalPersonalShare)}</div>
                                </div>
                                <div class="summary-row">
                                    <div class="member-total-label">Balance</div>
                                    ${balanceHtml}
                                </div>
                            </div>
                            <button class="cta-button button-sm add-contribution-btn">Add Contribution</button>
                        `;
                        membersSection.appendChild(memberCard);
                    });
                }

                // Render Summary
                totalContributionEl.textContent = formatCurrency(totalContribution);
                equalShareEl.innerHTML = `${formatCurrency(averageShare)} <span>avg/person</span>`;
                totalWaiversEl.textContent = formatCurrency(totalWaivers);
            };
            
            const addMember = (e) => {
                e.preventDefault();
                const name = memberNameInput.value.trim();
                if (name) {
                    const newMember = {
                        id: Date.now(),
                        name: name,
                        waiver: 0,
                        waiverDistributeIds: []
                    };
                    members.push(newMember);
                    memberNameInput.value = '';
                    saveAndRender();
                }
            };
            
            const handleMemberSectionClick = (e) => {
                const memberCard = e.target.closest('.member-card');
                if (!memberCard) return;
                
                const memberId = parseInt(memberCard.dataset.memberId);

                if (e.target.closest('.remove-member-btn')) {
                    showConfirmModal(
                        `Are you sure you want to remove this member and all related data?`,
                        () => {
                            members = members.filter(m => m.id !== memberId);
                            contributions = contributions.filter(c => c.memberId !== memberId);
                            transfers = transfers.filter(t => t.fromId !== memberId && t.toId !== memberId);
                            saveAndRender();
                        }
                    );
                    return;
                }

                if (e.target.closest('.add-contribution-btn')) {
                    openContributionModal(memberId);
                    return;
                }
                
                if (e.target.closest('.edit-member-btn')) {
                    openEditMemberModal(memberId);
                    return;
                }

                if (e.target.closest('.remove-contribution-btn')) {
                    e.stopPropagation(); // Stop propagation so item click doesn't fire
                    const contributionItem = e.target.closest('.contribution-item');
                    const contributionId = parseInt(contributionItem.dataset.contributionId);
                    contributions = contributions.filter(c => c.id !== contributionId);
                    saveAndRender();
                    return;
                }

                // Handle click on contribution item to open details modal
                const contributionItem = e.target.closest('.contribution-item');
                if (contributionItem) {
                    const contributionId = parseInt(contributionItem.dataset.contributionId);
                    openContributionDetailsModal(contributionId);
                }
            };

            const openContributionModal = (memberId) => {
                const member = members.find(m => m.id === memberId);
                if (member) {
                    contributionModalTitle.textContent = `Add for ${member.name}`;
                    contributionMemberIdInput.value = memberId;
                    contributionForm.reset();
                    contributionModal.classList.add('active');
                    contributionTitleInput.focus();
                }
            };

            const openContributionDetailsModal = (contributionId) => {
                const contribution = contributions.find(c => c.id === contributionId);
                if (!contribution) return;

                detailContributionIdInput.value = contribution.id;
                detailTitleInput.value = contribution.title;
                detailAmountInput.value = contribution.amount;

                // Render Member Selection List
                exceptionMembersList.innerHTML = '';
                const excluded = contribution.excludedMembers || [];

                members.forEach(member => {
                    const isSelected = !excluded.includes(member.id);
                    const chip = document.createElement('div');
                    chip.className = `member-select-item ${isSelected ? 'selected' : ''}`;
                    chip.textContent = member.name;
                    chip.dataset.memberId = member.id;
                    
                    chip.addEventListener('click', () => {
                        chip.classList.toggle('selected');
                    });
                    
                    exceptionMembersList.appendChild(chip);
                });

                contributionDetailsModal.classList.add('active');
            };

            const handleContributionUpdate = (e) => {
                e.preventDefault();
                const id = parseInt(detailContributionIdInput.value);
                const title = detailTitleInput.value.trim();
                const amount = parseFloat(detailAmountInput.value);
                
                // Gather excluded members
                const newExcluded = [];
                const chips = exceptionMembersList.querySelectorAll('.member-select-item');
                chips.forEach(chip => {
                    if (!chip.classList.contains('selected')) {
                        newExcluded.push(parseInt(chip.dataset.memberId));
                    }
                });

                // Prevent excluding everyone
                if (newExcluded.length === members.length) {
                    showConfirmModal("You cannot exclude everyone from a contribution.", () => {}, true);
                    return;
                }

                const contribution = contributions.find(c => c.id === id);
                if (contribution && title && amount >= 0) {
                    contribution.title = title;
                    contribution.amount = amount;
                    contribution.excludedMembers = newExcluded;
                    closeAllModals();
                    saveAndRender();
                }
            };

            const addContribution = (e) => {
                e.preventDefault();
                const memberId = parseInt(contributionMemberIdInput.value);
                const title = contributionTitleInput.value.trim();
                const amount = parseFloat(contributionAmountInput.value);

                if (memberId && title && amount >= 0) {
                    const newContribution = {
                        id: Date.now(),
                        memberId: memberId,
                        title: title,
                        amount: amount,
                        excludedMembers: []
                    };
                    contributions.push(newContribution);
                    closeAllModals();
                    saveAndRender();
                }
            };

            const openEditMemberModal = (memberId) => {
                const member = members.find(m => m.id === memberId);
                if (member) {
                    editMemberModalTitle.textContent = `Edit ${member.name}`;
                    editMemberIdInput.value = member.id;
                    editMemberNameInput.value = member.name;
                    editMemberWaiverInput.value = (member.waiver || 0).toFixed(2);
                    
                    // Populate Waiver Distribute List
                    waiverDistributeList.innerHTML = '';
                    const distributeIds = member.waiverDistributeIds || [];
                    
                    // Create chips for all OTHER members
                    members.filter(m => m.id !== member.id).forEach(otherMember => {
                        const isSelected = distributeIds.includes(otherMember.id);
                        const chip = document.createElement('div');
                        chip.className = `member-select-item ${isSelected ? 'selected' : ''}`;
                        chip.textContent = otherMember.name;
                        chip.dataset.memberId = otherMember.id;
                        
                        chip.addEventListener('click', () => {
                            chip.classList.toggle('selected');
                        });
                        
                        waiverDistributeList.appendChild(chip);
                    });

                    editMemberModal.classList.add('active');
                }
            };

            const handleUpdateMember = (e) => {
                e.preventDefault();
                const memberId = parseInt(editMemberIdInput.value);
                const newName = editMemberNameInput.value.trim();
                const newWaiver = parseFloat(editMemberWaiverInput.value);
                
                // Gather distribution IDs
                const newDistributeIds = [];
                const chips = waiverDistributeList.querySelectorAll('.member-select-item');
                chips.forEach(chip => {
                    if (chip.classList.contains('selected')) {
                        newDistributeIds.push(parseInt(chip.dataset.memberId));
                    }
                });

                const member = members.find(m => m.id === memberId);
                if (member && newName && newWaiver >= 0) {
                    member.name = newName;
                    member.waiver = newWaiver;
                    member.waiverDistributeIds = newDistributeIds;
                    closeAllModals();
                    saveAndRender();
                }
            };
            
            const openTransferModal = () => {
                if (members.length < 2) {
                    showConfirmModal("You need at least two members to make a transfer.", () => {}, true);
                    return;
                }
                transferFromSelect.innerHTML = members.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
                transferToSelect.innerHTML = members.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
                transferForm.reset();
                transferModal.classList.add('active');
            };

            const addTransfer = (e) => {
                e.preventDefault();
                const fromId = parseInt(transferFromSelect.value);
                const toId = parseInt(transferToSelect.value);
                const amount = parseFloat(transferAmountInput.value);

                if (fromId === toId) {
                    showConfirmModal("Cannot transfer money to the same person.", () => {}, true);
                    return;
                }

                if (fromId && toId && amount > 0) {
                    transfers.push({ id: Date.now(), fromId, toId, amount });
                    closeAllModals();
                    saveAndRender();
                }
            };

            const openSettingsModal = () => settingsModal.classList.add('active');
            
            // --- History Logic ---
            let currentHistoryTab = 'all';

            const renderHistory = () => {
                historyList.innerHTML = '';
                
                // 1. Contributions & Transfers (Time-based)
                const timeBasedActivity = [
                    ...contributions.map(c => ({ ...c, type: 'contribution', timestamp: c.id })),
                    ...transfers.map(t => ({ ...t, type: 'transfer', timestamp: t.id }))
                ];

                // 2. Waivers (State-based, always "current")
                const waiverActivity = [];
                members.forEach(m => {
                    if ((m.waiver || 0) > 0) {
                        waiverActivity.push({
                            type: 'waiver',
                            memberId: m.id,
                            amount: m.waiver,
                            distributeIds: m.waiverDistributeIds || [],
                            timestamp: Date.now() // Treat as "Now" for sorting if needed, or keep separate
                        });
                    }
                });

                // Filter based on Tab
                let itemsToShow = [];
                if (currentHistoryTab === 'all') {
                    // Show time-based sorted by date desc
                    itemsToShow = timeBasedActivity.sort((a, b) => b.timestamp - a.timestamp);
                    // Append waivers at the top as "Active Status"
                    // Or merge them? Let's put them at the top as they are "Current State"
                    // Actually, let's strictly follow types. If 'all', show everything.
                    // But waivers don't have a real date. Let's filter strict.
                    // To keep it clean: All = Contribs + Transfers. Waivers are in their own tab or special section.
                    // However, user might expect everything. Let's merge active waivers at the top.
                    itemsToShow = [...waiverActivity, ...itemsToShow];
                } else if (currentHistoryTab === 'waiver') {
                    itemsToShow = waiverActivity;
                } else {
                    itemsToShow = timeBasedActivity.filter(i => i.type === currentHistoryTab).sort((a, b) => b.timestamp - a.timestamp);
                }

                if (itemsToShow.length === 0) {
                    noHistoryMsg.style.display = 'block';
                    noHistoryMsg.textContent = currentHistoryTab === 'waiver' ? "No active personal waivers." : "No activity recorded yet.";
                } else {
                    noHistoryMsg.style.display = 'none';
                    
                    itemsToShow.forEach(item => {
                        const li = document.createElement('li');
                        li.className = 'history-item';
                        
                        let iconHtml = '';
                        let contentHtml = '';

                        if (item.type === 'contribution') {
                            const date = new Date(item.timestamp);
                            const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                            const member = members.find(m => m.id === item.memberId);
                            const memberName = member ? member.name : 'Unknown';
                            
                            const excluded = item.excludedMembers || [];
                            let splitText = '';
                            if (excluded.length > 0) {
                                const excludedNames = excluded.map(id => {
                                    const m = members.find(mem => mem.id === id);
                                    return m ? m.name : 'Unknown';
                                }).join(', ');
                                splitText = ` (Excluding: ${excludedNames})`;
                            }

                            iconHtml = `
                                <div class="history-icon contribution">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1v22M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
                                </div>
                            `;
                            contentHtml = `
                                <div class="history-title">${item.title}</div>
                                <div class="history-meta">${dateStr} • by ${memberName}</div>
                                <div class="history-amount">${formatCurrency(item.amount)}</div>
                                ${splitText ? `<div class="history-details">${splitText}</div>` : ''}
                            `;
                        } else if (item.type === 'transfer') {
                            const date = new Date(item.timestamp);
                            const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                            const fromMember = members.find(m => m.id === item.fromId);
                            const toMember = members.find(m => m.id === item.toId);
                            const fromName = fromMember ? fromMember.name : 'Unknown';
                            const toName = toMember ? toMember.name : 'Unknown';

                            iconHtml = `
                                <div class="history-icon transfer">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="7" y1="17" x2="17" y2="7"></line><polyline points="7 7 17 7 17 17"></polyline></svg>
                                </div>
                            `;
                            contentHtml = `
                                <div class="history-title">Money Transfer</div>
                                <div class="history-meta">${dateStr}</div>
                                <div class="history-details">${fromName} ➔ ${toName}</div>
                                <div class="history-amount">${formatCurrency(item.amount)}</div>
                            `;
                        } else if (item.type === 'waiver') {
                            const member = members.find(m => m.id === item.memberId);
                            const memberName = member ? member.name : 'Unknown';
                            
                            // Determine distribution
                            const distributeIds = item.distributeIds || [];
                            const targets = members.filter(mem => mem.id !== item.memberId && distributeIds.includes(mem.id));
                            const targetNames = targets.length > 0 ? targets.map(t => t.name).join(', ') : 'All Others';

                            iconHtml = `
                                <div class="history-icon waiver">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 9V7a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2"></path><line x1="9" y1="9" x2="9" y2="9.01"></line><path d="M9 19h10a2 2 0 0 0 2-2v-6a2 2 0 0 0-2-2H9a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2z"></path></svg>
                                </div>
                            `;
                            contentHtml = `
                                <div class="history-title">Active Personal Waiver</div>
                                <div class="history-meta">Beneficiary: ${memberName}</div>
                                <div class="history-details">Cost covered by: ${targetNames}</div>
                                <div class="history-amount">${formatCurrency(item.amount)}</div>
                            `;
                        }

                        li.innerHTML = iconHtml + '<div class="history-content">' + contentHtml + '</div>';
                        historyList.appendChild(li);
                    });
                }
            };

            const openHistoryModal = () => {
                currentHistoryTab = 'all'; // Reset to all on open
                historyTabs.forEach(t => t.classList.remove('active'));
                historyTabs[0].classList.add('active'); // Set visual active
                renderHistory();
                historyModal.classList.add('active');
            };

            // Tab Click Handler
            historyTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    historyTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentHistoryTab = tab.dataset.tab;
                    renderHistory();
                });
            });

            const closeAllModals = () => allModals.forEach(modal => modal.classList.remove('active'));
            
            const resetApp = () => {
                showConfirmModal(
                    'This will delete all members, contributions, and transfers. Are you sure?',
                    () => {
                        members = [];
                        contributions = [];
                        transfers = [];
                        closeAllModals();
                        saveAndRender();
                    }
                );
            };

            const saveAndRender = () => {
                saveState();
                render();
            };

            const showConfirmModal = (message, callback, isInfoModal = false) => {
                confirmModalText.textContent = message;
                confirmCallback = callback;
                confirmCancelBtn.style.display = isInfoModal ? 'none' : 'flex';
                confirmOkBtn.textContent = isInfoModal ? 'OK' : 'Confirm';
                confirmOkBtn.classList.toggle('button-danger', !isInfoModal);
                confirmModal.classList.add('active');
            };

            const hideConfirmModal = () => {
                confirmModal.classList.remove('active');
                confirmCallback = null;
            };

            const getReportContent = () => {
                 if (members.length === 0) {
                    showConfirmModal("There is no data to generate a report.", () => {}, true);
                    return null;
                }
                let content = `Tour Contribution Report: ${tourName}\nGenerated on: ${new Date().toLocaleString()}\n========================================\n\n`;
                
                // 1. Calculate Costs (Replicated Logic)
                const finalMemberCosts = {};
                members.forEach(m => finalMemberCosts[m.id] = 0);

                contributions.forEach(c => {
                    const excluded = c.excludedMembers || [];
                    const includedCount = members.length - excluded.length;
                    if (includedCount > 0) {
                        const share = c.amount / includedCount;
                        members.forEach(m => {
                            if (!excluded.includes(m.id)) finalMemberCosts[m.id] += share;
                        });
                    }
                });

                // 2. Apply Waivers
                members.forEach(m => {
                    const waiver = m.waiver || 0;
                    if (waiver > 0) {
                        finalMemberCosts[m.id] -= waiver;
                        const distributeIds = m.waiverDistributeIds || [];
                        let targets = members.filter(mem => mem.id !== m.id && distributeIds.includes(mem.id));
                        if (targets.length === 0) targets = members.filter(mem => mem.id !== m.id);
                        if (targets.length > 0) {
                            const share = waiver / targets.length;
                            targets.forEach(target => finalMemberCosts[target.id] += share);
                        }
                    }
                });

                const totalContribution = contributions.reduce((sum, c) => sum + c.amount, 0);
                const totalWaivers = members.reduce((sum, m) => sum + (m.waiver || 0), 0);
                
                content += "--- Summary ---\n";
                content += `Total Tour Cost: ${formatCurrency(totalContribution)}\n`;
                content += `Total Waivers: ${formatCurrency(totalWaivers)}\n`;
                content += `Total Members: ${members.length}\n\n========================================\n\n`;

                content += "--- Member Balances & Dues ---\n";
                members.forEach(member => {
                    const memberTotalContributions = contributions.filter(c => c.memberId === member.id).reduce((sum, c) => sum + c.amount, 0);
                    const totalSent = transfers.filter(t => t.fromId === member.id).reduce((sum, t) => sum + t.amount, 0);
                    const totalReceived = transfers.filter(t => t.toId === member.id).reduce((sum, t) => sum + t.amount, 0);
                    const effectiveTotalPaid = memberTotalContributions + totalSent - totalReceived;
                    const finalPersonalShare = finalMemberCosts[member.id];
                    const balance = effectiveTotalPaid - finalPersonalShare;

                    content += `\nMember: ${member.name}\n`;
                    content += `  - Total Contributions: ${formatCurrency(memberTotalContributions)}\n`;
                    content += `  - Amount Sent: ${formatCurrency(totalSent)}\n`;
                    content += `  - Amount Received: ${formatCurrency(totalReceived)}\n`;
                    content += `  - Personal Waiver: ${formatCurrency(member.waiver || 0)}\n`;
                    
                    // Add Waiver distribution details to report
                    if ((member.waiver || 0) > 0) {
                        const distributeIds = member.waiverDistributeIds || [];
                        const targets = members.filter(mem => mem.id !== member.id && distributeIds.includes(mem.id));
                        const targetNames = targets.length > 0 ? targets.map(t => t.name).join(', ') : 'All Others';
                        content += `    (Distributed among: ${targetNames})\n`;
                    }

                    content += `  - Final Personal Share: ${formatCurrency(finalPersonalShare)}\n`;
                    
                    if (Math.abs(balance) < 0.01) {
                        content += `  - Balance: Settled Up\n`;
                    } else if (balance > 0) {
                        content += `  - Balance: Gets back ${formatCurrency(balance)}\n`;
                    } else {
                        content += `  - Balance: Owes ${formatCurrency(Math.abs(balance))}\n`;
                    }
                });
                content += "\n========================================\n\n--- All Contributions Log ---\n";
                contributions.forEach(c => {
                    const member = members.find(m => m.id === c.memberId);
                    const excluded = c.excludedMembers || [];
                    
                    let splitInfo = '';
                    if (excluded.length > 0) {
                        const skippedNames = excluded.map(id => {
                            const m = members.find(mem => mem.id === id);
                            return m ? m.name : 'Unknown';
                        }).join(', ');
                        splitInfo = ` (Skipped: ${skippedNames})`;
                    }
                    
                    content += `- ${member ? member.name : 'Unknown'}: ${c.title}${splitInfo} - ${formatCurrency(c.amount)}\n`;
                });
                if (contributions.length === 0) content += "No contributions were made.\n";

                content += "\n========================================\n\n--- All Transfers Log ---\n";
                 transfers.forEach(t => {
                    const from = members.find(m => m.id === t.fromId);
                    const to = members.find(m => m.id === t.toId);
                    content += `- ${from ? from.name : 'N/A'} -> ${to ? to.name : 'N/A'}: ${formatCurrency(t.amount)}\n`;
                });
                if (transfers.length === 0) content += "No transfers were made.\n";
                return content;
            };

            const downloadReport = () => {
                const reportContent = getReportContent();
                if (!reportContent) return; 
                const safeName = (tourName || 'Tour').replace(/[^a-z0-9]/gi, '_').toLowerCase();
                const blob = new Blob([reportContent], { type: 'text/plain;charset=utf-8' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `${safeName}-report-${new Date().toISOString().split('T')[0]}.txt`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const copyReportToClipboard = () => {
                const reportContent = getReportContent();
                if (!reportContent) return;
                navigator.clipboard.writeText(reportContent)
                    .then(() => showConfirmModal("Report copied to clipboard!", () => {}, true))
                    .catch(err => {
                        console.error('Failed to copy report: ', err);
                        showConfirmModal("Could not copy report.", () => {}, true);
                    });
            };

            const downloadBackup = () => {
                const backupData = { tourName, members, contributions, transfers };
                const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
                const safeName = (tourName || 'Tour').replace(/[^a-z0-9]/gi, '_').toLowerCase();
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `${safeName}-backup-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (!data.members || !data.contributions || !data.transfers) throw new Error("Invalid backup file.");
                        const restore = () => {
                            tourName = data.tourName || 'Restored Tour';
                            members = data.members;
                            contributions = data.contributions;
                            transfers = data.transfers;
                            closeAllModals();
                            saveAndRender();
                            showConfirmModal("Backup restored successfully!", () => {}, true);
                        };
                        if (members.length > 0) {
                            showConfirmModal("This will overwrite current data. Continue?", restore);
                        } else {
                            restore();
                        }
                    } catch (error) {
                        showConfirmModal(`Error: Could not load backup.`, () => {}, true);
                    } finally {
                        e.target.value = null;
                    }
                };
                reader.readAsText(file);
            };

            // --- Event Listeners ---
            addMemberForm.addEventListener('submit', addMember);
            transferButton.addEventListener('click', openTransferModal);
            historyButton.addEventListener('click', openHistoryModal); // New Listener
            downloadReportButton.addEventListener('click', downloadReport);
            copyReportButton.addEventListener('click', copyReportToClipboard);
            settingsButton.addEventListener('click', openSettingsModal);
            tourNameInput.addEventListener('input', (e) => {
                tourName = e.target.value;
                saveState();
                tourTitleHeader.textContent = tourName || 'Tour Contribution Calculator';
            });
            backupButton.addEventListener('click', downloadBackup);
            uploadInput.addEventListener('change', handleFileUpload);
            resetButton.addEventListener('click', resetApp);
            closeButtons.forEach(btn => btn.addEventListener('click', closeAllModals));
            cancelButtons.forEach(btn => btn.addEventListener('click', closeAllModals));
            allModals.forEach(m => m.addEventListener('click', (e) => e.target === m && closeAllModals()));
            contributionForm.addEventListener('submit', addContribution);
            contributionDetailsForm.addEventListener('submit', handleContributionUpdate); // New Listener
            editMemberForm.addEventListener('submit', handleUpdateMember);
            transferForm.addEventListener('submit', addTransfer);
            membersSection.addEventListener('click', handleMemberSectionClick);
            confirmCancelBtn.addEventListener('click', hideConfirmModal);
            confirmOkBtn.addEventListener('click', () => {
                if (typeof confirmCallback === 'function') confirmCallback();
                hideConfirmModal();
            });
            confirmModal.addEventListener('click', (e) => e.target === confirmModal && hideConfirmModal());

            // --- Initial Load ---
            loadState();
            render();

            // --- PWA Service Worker Registration ---
            if ('serviceWorker' in navigator) {
                const swContent = `
                    const CACHE_NAME = 'tour-calc-cache-v1';
                    const ASSETS_TO_CACHE = ['./'];
                    self.addEventListener('install', e => e.waitUntil(caches.open(CACHE_NAME).then(c => c.addAll(ASSETS_TO_CACHE))));
                    self.addEventListener('activate', e => e.waitUntil(caches.keys().then(n => Promise.all(n.map(c => c !== CACHE_NAME ? caches.delete(c) : null)))));
                    self.addEventListener('fetch', e => e.respondWith(fetch(e.request).catch(() => caches.match(e.request))));
                `;
                const swBlob = new Blob([swContent], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(swBlob);
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register(swUrl)
                        .then(reg => console.log('SW registration successful:', reg.scope))
                        .catch(err => console.log('SW registration failed:', err));
                });
            }
        });
    </script>
</body>
</html>
